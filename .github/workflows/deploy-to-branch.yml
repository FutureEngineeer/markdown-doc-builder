name: Build and Deploy to Branch

on:
  push:
    branches:
      - main
  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 12 Ñ‡Ð°ÑÐ¾Ð² Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ²
  schedule:
    - cron: '0 */12 * * *'
  
  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  workflow_dispatch:

# Ð Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¸ ÐºÐµÑˆÐ° Ð¿ÐµÑ€ÐµÐ´ ÑÐ±Ð¾Ñ€ÐºÐ¾Ð¹
    - name: Clean temporary files and cache
      run: |
        echo "ðŸ§¹ Cleaning temporary files and cache..."
        rm -rf .temp
        rm -rf temp
        rm -rf dist
        echo "âœ“ Cleanup complete"
    
    - name: Build site (from scratch)
      run: npm run build:all
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
    - name: List generated files
      run: |
        echo "ðŸ“ Generated directory structure:"
        find dist -type d | head -20
        echo ""
        echo "ðŸ“„ Sample HTML files:"
        find dist -name "*.html" | head -20
        echo ""
        echo "ðŸ” Checking case sensitivity:"
        ls -la dist/ | grep -i cln || echo "No CLN directory found"
        ls -la dist/cln/ 2>/dev/null | head -10 || echo "No dist/cln directory"
        ls -la dist/CLN/ 2>/dev/null | head -10 || echo "No dist/CLN directory"
    
    - name: Deploy to gh-pages branch
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        publish_branch: gh-pages
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Deploy: ${{ github.sha }}'
