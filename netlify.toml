[build]
  # Команда для сборки с оптимизацией
  command = "npm run build:optimized"
  
  # Папка с результатом сборки
  publish = "dist"
  
  # Переменные окружения
  environment = { NODE_VERSION = "18" }

[build.processing]
  # Включаем обработку для дополнительной оптимизации
  skip_processing = false

[build.processing.css]
  bundle = true
  minify = true

[build.processing.js]
  bundle = true
  minify = true

[build.processing.html]
  pretty_urls = true

[build.processing.images]
  compress = true

# SPA fallback - для правильной работы роутинга
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
  force = false
  
# Custom error pages
[[redirects]]
  from = "/*"
  to = "/assets/errors/404.html"
  status = 404

# Server error page  
[[redirects]]
  from = "/*"
  to = "/assets/errors/500.html"
  status = 500

# Кеширование CSS и JS (immutable - никогда не меняются)
[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    X-Content-Type-Options = "nosniff"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    X-Content-Type-Options = "nosniff"

# Кеширование статических ресурсов (изображения, шрифты)
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    X-Content-Type-Options = "nosniff"

# HTML файлы - всегда проверять актуальность
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"
    X-Content-Type-Options = "nosniff"
    X-Frame-Options = "SAMEORIGIN"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"

# Service Worker - короткое кеширование для быстрых обновлений
[[headers]]
  for = "/sw.js"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"
    Service-Worker-Allowed = "/"

# Preload критических ресурсов
[[headers]]
  for = "/"
  [headers.values]
    Link = '''
    </assets/styles.min.css>; rel=preload; as=style,
    </assets/logo.png>; rel=preload; as=image,
    </assets/scripts/core.js>; rel=preload; as=script
    '''

# Настройки для GitHub webhook (автоматическая пересборка)
[build.environment]
  # Netlify будет автоматически пересобирать при изменениях в репозитории
  AUTO_DEPLOY = "true"

# Плагины Netlify
[[plugins]]
  package = "@netlify/plugin-sitemap"
  
  [plugins.inputs]
    buildDir = "dist"

# Оптимизация изображений (если установлен плагин)
# [[plugins]]
#   package = "netlify-plugin-image-optim"