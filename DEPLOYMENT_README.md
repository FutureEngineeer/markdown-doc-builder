# Настройка автоматического деплоя

Этот документ описывает настройку автоматического деплоя для GitHub Pages и Netlify с инкрементальными обновлениями.

## Возможности

- ✅ Автоматическая сборка при изменениях в отслеживаемых репозиториях
- ✅ Инкрементальные обновления (обновляются только измененные файлы)
- ✅ Кеширование для ускорения сборки
- ✅ Ограничение частоты обновлений (не чаще 12 часов)
- ✅ Поддержка GitHub Pages и Netlify
- ✅ Принудительная пересборка при изменениях в основном проекте

## GitHub Pages

### 1. Настройка репозитория

1. Перейдите в Settings → Pages
2. Выберите Source: "GitHub Actions"
3. Workflow будет автоматически использовать `.github/workflows/build-and-deploy.yml`

### 2. Настройка отслеживаемых репозиториев

В файле `config.yaml` добавьте репозитории для отслеживания:

```yaml
build:
  input:
    githubRepositories:
      - url: "https://github.com/username/repo1"
        description: "Описание репозитория 1"
        alias: "Repo1"  # Псевдоним для сокращения названия
      - url: "https://github.com/username/repo2"
        description: "Описание репозитория 2"
```

### 3. Автоматические обновления

Система автоматически:
- Проверяет изменения каждые 12 часов
- Обновляет только измененные репозитории
- Делает полную пересборку при изменениях в основном проекте
- Кеширует скачанные файлы для ускорения

### 4. Ручной запуск

Вы можете запустить сборку вручную:
1. Перейдите в Actions → Build and Deploy
2. Нажмите "Run workflow"

## Netlify

### 1. Подключение репозитория

1. Войдите в Netlify Dashboard
2. Нажмите "New site from Git"
3. Выберите ваш GitHub репозиторий
4. Настройки будут автоматически взяты из `netlify.toml`

### 2. Настройки сборки

Файл `netlify.toml` уже настроен:
- Build command: `npm run build:netlify`
- Publish directory: `dist`
- Node.js версия: 18

### 3. Автоматические деплои

Netlify автоматически:
- Пересобирает сайт при пуше в main ветку
- Использует кеширование для ускорения
- Оптимизирует статические ресурсы

### 4. Переменные окружения

При необходимости добавьте в Netlify Dashboard:
- `NODE_VERSION=18`
- Другие переменные для вашего проекта

## Кеширование

### Типы кеша

1. **Кеш репозиториев** (`.temp/repos-cache.json`)
   - Хранит скачанные файлы репозиториев
   - Время жизни: 12 часов
   - Проверяет изменения через GitHub API

2. **Кеш HTML генерации** (в памяти)
   - Ускоряет повторную генерацию HTML
   - Сбрасывается при изменениях

3. **Кеш файлов** (`.temp/file-hashes.json`)
   - Отслеживает изменения локальных файлов
   - Используется для инкрементальных обновлений

### Очистка кеша

Для принудительной очистки кеша:

```bash
# Очистить весь кеш
npm run build:all -- --force-rebuild

# Или вручную
rm -rf .temp/
```

## Мониторинг

### Логи сборки

GitHub Actions и Netlify предоставляют подробные логи:
- Какие репозитории были обновлены
- Время сборки
- Ошибки и предупреждения
- Статистика кеша

### Статус сборки

Добавьте бейджи в README:

```markdown
[![Build Status](https://github.com/username/repo/workflows/Build%20and%20Deploy/badge.svg)](https://github.com/username/repo/actions)
[![Netlify Status](https://api.netlify.com/api/v1/badges/your-site-id/deploy-status)](https://app.netlify.com/sites/your-site/deploys)
```

## Оптимизация

### Ускорение сборки

1. **Используйте кеш** - не отключайте кеширование без необходимости
2. **Ограничьте репозитории** - добавляйте только нужные репозитории
3. **Оптимизируйте изображения** - используйте сжатые форматы
4. **Минимизируйте зависимости** - удалите неиспользуемые пакеты

### Экономия ресурсов

1. **Расписание** - используйте разумные интервалы обновления
2. **Условная сборка** - сборка запускается только при реальных изменениях
3. **Инкрементальность** - обновляются только измененные файлы

## Устранение проблем

### Частые проблемы

1. **Сборка не запускается**
   - Проверьте права доступа в Settings → Actions
   - Убедитесь, что workflow файлы в правильной папке

2. **Кеш не работает**
   - Проверьте наличие папки `.temp`
   - Убедитесь в корректности `config.yaml`

3. **Репозитории не обновляются**
   - Проверьте URL репозиториев в конфигурации
   - Убедитесь в доступности репозиториев

4. **Netlify не собирается**
   - Проверьте `netlify.toml`
   - Убедитесь в наличии `package.json`

### Отладка

Включите подробные логи:

```bash
# Локальная сборка с отладкой
DEBUG=* npm run build:all

# Проверка конфигурации
node -e "console.log(require('js-yaml').load(require('fs').readFileSync('config.yaml', 'utf8')))"
```

## Безопасность

### Рекомендации

1. **Ограничьте репозитории** - добавляйте только доверенные репозитории
2. **Проверяйте содержимое** - регулярно проверяйте генерируемый контент
3. **Обновляйте зависимости** - используйте актуальные версии пакетов
4. **Мониторинг** - следите за логами сборки

### Права доступа

- GitHub Actions имеют минимальные необходимые права
- Netlify получает доступ только к публичному репозиторию
- Кеш хранится только локально и в CI/CD

## Дополнительные возможности

### Webhook для мгновенных обновлений

Для мгновенного обновления при изменениях в репозиториях:

1. Настройте webhook в отслеживаемых репозиториях
2. URL: `https://api.github.com/repos/username/your-site/dispatches`
3. Event: `repository_dispatch`
4. Payload: `{"event_type": "external_repo_update"}`

### Кастомные команды

Добавьте в `package.json`:

```json
{
  "scripts": {
    "build:force": "node build-all.js --force-rebuild",
    "build:clean": "rm -rf dist .temp && npm run build:all",
    "cache:clear": "rm -rf .temp",
    "cache:info": "node -e \"console.log(require('./components/githubFetcher').getCacheInfo())\""
  }
}
```