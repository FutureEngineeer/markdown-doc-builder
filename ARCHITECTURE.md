# Архитектура генерации сайта

## Обзор

Система генерации сайта работает в **3 чётких этапа**:

### 1️⃣ Индексация (Phase 1-2)
**Файл:** `build-all-v2.js` → `indexAllFiles()` + `generateNavigationTemplates()`

- Сканирует все локальные markdown файлы
- Скачивает и индексирует GitHub репозитории из `doc-config.yaml`
- Строит полную структуру файлов на основе иерархии
- Сохраняет индекс в `.temp/hierarchy-info.json`

**Результат:** Полная карта сайта с информацией о:
- Всех файлах (локальных и из репозиториев)
- Иерархии навигации
- Видимости файлов (в sidebar / hidden / ignored)

### 2️⃣ Генерация контента (Phase 3)
**Файл:** `converter.js` → `generateMainContentOnly()`

- Генерирует **ТОЛЬКО** контент `<main>` для каждой страницы
- Парсит markdown в HTML
- Обрабатывает карточки (features, specs, projects и т.д.)
- Разрешает внутренние ссылки
- Сохраняет файлы с чистым контентом (без HTML обёртки)

**Результат:** HTML файлы содержат только `<main>...</main>` без header, footer, navigation

### 3️⃣ Постпроцессинг (Phase 4)
**Файл:** `converter.js` → `wrapMainContentInHTML()`

- Читает файлы с контентом `<main>`
- Генерирует для каждого файла:
  - `<header>` с breadcrumb
  - `<footer>` с социальными ссылками
  - `<aside class="hamburger-menu">` - полная структура сайта с хайлайтом текущей страницы
  - `<aside class="section-map">` - структура текущего раздела с хайлайтом
  - Теги `<link>` для стилей
  - Теги `<script>` для скриптов
- Оборачивает контент в полный HTML документ

**Результат:** Полноценные HTML страницы с навигацией, точно соответствующей индексированной структуре

## Ключевые особенности

### Навигация на основе индекса
- **Hamburger menu** и **section map** генерируются на основе `.temp/hierarchy-info.json`
- Структура навигации **В ТОЧНОСТИ** соответствует `doc-config.yaml`
- Хайлайт текущей страницы работает через точное сравнение путей

### Разделение ответственности
- **Индексация** - знает о структуре проекта
- **Генерация контента** - знает о markdown и HTML
- **Постпроцессинг** - знает о навигации и шаблонах

### Преимущества архитектуры
1. **Модульность** - каждый этап независим
2. **Переиспользование** - навигация генерируется один раз для всех страниц
3. **Производительность** - параллельная обработка файлов возможна
4. **Отладка** - легко проверить результат каждого этапа
5. **Расширяемость** - легко добавить новые этапы обработки

## Файлы и их роли

### Основные файлы
- `build-all-v2.js` - Оркестратор всего процесса сборки
- `converter.js` - Конвертация markdown → HTML
- `components/hamburgerMenu.js` - Генерация полной навигации сайта
- `components/newSectionMap.js` - Генерация навигации раздела
- `components/indexer.js` - Индексация файлов (устаревший, не используется)

### Конфигурация
- `website/doc-config.yaml` - Корневая конфигурация иерархии
- `website/*/doc-config.yaml` - Конфигурация разделов
- `.temp/hierarchy-info.json` - Сгенерированный индекс (используется навигацией)

## Пример работы

```bash
# Запуск полной сборки
node build-all-v2.js

# Результат:
# 1. Индексация → .temp/hierarchy-info.json
# 2. Генерация → dist/**/*.html (только <main>)
# 3. Постпроцессинг → dist/**/*.html (полный HTML)
```

## Хайлайт текущей страницы

Логика хайлайта:
1. В `wrapMainContentInHTML()` определяется путь текущего файла относительно `dist/`
2. Путь передаётся в `generateHamburgerMenu()` и `generateNewSectionMap()`
3. Функции сравнивают `normalizedCurrentFile === fileHtmlPath` (точное сравнение)
4. Совпадающий элемент получает класс `active`

**Важно:** Используется точное сравнение путей, без `endsWith()` или `includes()`, чтобы избежать ложных срабатываний (например, `main.html` vs `project-alpha/main.html`).
